<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <script type="text/javascript">
        
            // 1. Model
            let canvas, context, W, H;
            let mx = 0, my = 0;

            let piese = [];
            
            
            let w = 120, h = 90;
            let imagine ;

            let vY =2;
            let indexSelectat = -1;
            let dx, dy;

            // 2. Desenare
            function desenare() {
                // // a) stergere scena
                context.drawImage(imagine, 0, 0);
                context.fillStyle = 'rgba(200, 200, 200, 0.8)';
                context.fillRect(0, 0, W, H);
                // // b) desenare obiecte
                context.fillStyle = 'red';
                context.strokeStyle = 'green';
                context.lineWidth = 3;

                for (let piesa of piese) {
                context.drawImage(imagine, piesa.sx, piesa.sy, w, h, piesa.x, piesa.y, w, h);
                if (indexSelectat >= 0 && piese[indexSelectat]===piesa) {
                context.strokeRect(piesa.x, piesa.y, w, h);
                }

                if (piesa.gata) {
                    context.fillStyle = 'rgba(0, 200, 0, 0.4)';
                    context.fillRect(piesa.x, piesa.y, w, h);
                }
            }

            let pieseRamase = piese.filter( item => !item.gata);
            if (pieseRamase.length === 0) {
                context.drawImage(imagine, 0, 0);
                context.font = 'bold 128pt Tahoma';
                context.textBaseline = 'middle';
                context.textAlign = 'center';
                context.fillText('Ai castigat!', W/2, H/2);
                context.strokeText('Ai castigat!', W/2, H/2);
            }

                // // c) programare executie
                requestAnimationFrame(desenare);
            }

            // 3. Actualizare model
            function actualizareModel() {
            if (indexSelectat >=0) {
                piese[indexSelectat].x = mx-dx;
                piese[indexSelectat].y = my-dy;
            }
            }

            // 4. Tratare evenimente (actualizarea modelului)
            function mouseMove(e) {
                mx = Math.round(e.x - 
                    canvas.getBoundingClientRect().x); 
                my = Math.round(e.y - 
                    canvas.getBoundingClientRect().y);
            } 

            function mouseDown() {

                for (let i =piese.length-1; i>=0; i--) {
                    let mouseInPiesa = mx >= piese[i].x && mx <= piese[i].x + w
                                    && my >= piese[i].y && my <= piese[i].y + h;

                    if (!piese[i].gata && mouseInPiesa) {
                            dx = mx - piese[i].x;
                            dy = my - piese[i].y;
                 
                        let piesa = piese.splice(i, 1)[0];
                        piese.push(piesa);
                        indexSelectat = piese.length -1;
                 
                            break;
                        }
                }
            }

                

            function mouseUp() {


                if (indexSelectat >=0) {
                    let p = piese[indexSelectat];
                    let distanta = (p.x - p.sx)*(p.x-p.sx) +
                        (p.y - p.sy)*(p.y - p.sy);
                    distanta = Math.sqrt(distanta);

                    if (distanta < 60) {
                        p.x = p.sx;
                        p.y = p.sy;
                        p.gata = true;
                    }
                }


                indexSelectat = -1;
            }

        function aplicatie() {

                imagine = document.createElement('img');
                imagine.src = './penguins.jpg';
                imagine.addEventListener('load', e => {
                    // initializare model
                    canvas = document.querySelector('canvas');
                    context = canvas.getContext('2d');
                    W = canvas.width = imagine.naturalWidth;
                    H = canvas.height = imagine.naturalHeight;


                    let n =3;
                    w = W/n;
                    h = H/n;

                    for (let c=0; c<n;c++) {
                        for (let l =0; l<n; l++) {
                            piese.push({
                                x:c*w + Math.random()*70, 
                                y:l*h+ Math.random()*70 ,
                                sx:c*w,
                                sy:l*h
                            });
                        }
                    }

                    // pornire aplicatie
                desenare();

                setInterval(actualizareModel, 20);

                document.addEventListener('mousemove', mouseMove);
                document.addEventListener('mousedown', mouseDown);
                document.addEventListener('mouseup', mouseUp);
                });

            
            

        }

        document.addEventListener('DOMContentLoaded', aplicatie);

        </script>
    </head>
    <body>
        <canvas width="600" height="400"></canvas>
    </body>
</html>